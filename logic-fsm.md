# Developing the state machine

In chapter [Making the board interactive](./logic-events.md#defining-the-state-machine) we saw that the board basically behaves accordingly to a certain state machine. That state machine and the algorithm that described in that same chapter is what we are going to implement now. Let's go back to `board.js` and start writing `_onClickHandler`. When we left the development on that function, we were experimenting with events. Let's remove the `console.log` that we wrote and let's start from here:

```javascript
function _onClickHandler(e) {
    // The code will end up here...
}
```

## Defining the cancel procedure
The first thing we wanna do is defining an internal function (a function that only `_onClickHandler` can access to) which deals with cancelling the operation. As we saw in the algorithm diagram in chapter [Making the board interactive](./logic-events.md), we have many checkpoints, and if something goes wrong, instead of failing, we cancel the operation.

The way to define a function which is visible to only one other function is to have former defined insinde the latter, so let's do this:

```javascript
function _onClickHandler(e) {
    function cancel(phase) {
        // Code for the internal function here...
    }

    // Code for the click handler here...
}
```

Like this, `cancel` can only be called from inside `_onClickHandler`. We want to make sure that `cancel` can only be called by the click handler because this functionality is extremely specific to this context. Before digging into the details of the 2 functions, we need to explain the approach we are planning for canceling one operation.

### Understanding how to cancel an operation
Events are not easy to understand and can be complicated. However here we will try to describe them in a very easy way. The key concept is understanding that events travel across elements in the page.

If you recall, we have defined 2 event handlers for the `click` event:

- One in the `Board` module on the `container` element.
- One in the `House` module on every `house` element.

What happens when a user clicks on an house on the page? To understand this answer, we need to focus on the page subtree that starts from that element and walks all the parent elements up to the `<body>` element. In our case, we have the following subtree:

```html
<body>
    <div class="contianer">
        <div class="house"></div>
    </div>
</body>
```

When the user clicks on that house `<div class="house"></div>`, this is what happens:

1. A `click` event is generated by the browser and is sent to the `<body>` element.
2. Right after, the event is sent to the `<div class="contianer">` element.
3. In the end, the event reaches the `<div class="house">` element.

Everytime the event reaches one element, if there are listeners registered on that element for the `click` event, those will be executed. Since both `<div class="contianer">` and `<div class="house">` define one event handler for the `click` event, first the event handler for the container is executed and then the one for the house. This dynamics is called _event propagation_.

#### Changing the event flow
However, if anyone of the event handlers calls `stopPropagation`, then the event will stop and not proceed any further down.

The same event traverses the subtree until it reaches `<div class="house"></div>`. This last element is called _target element_ because is the element which was actually clicked by the user and that is the element where the event chain will stop.

Every intermediate element that the event traverses before reaching the target is called a _non-target element_.

An event handler on an element for a certain event is registered in this way:

```javascript
element.addEventListener("click", clickEventHandler);

function clickEventHandler(e) {
    // The handler code
}
```

The event handler is `clickEventHandler` (we have coded something similar so far) and you see it always accepts an argument called `e`. That argument is called `event arguments` because it will contain information about the event as it traverses the subtree. We are interested in 2 particular properties of this object:

- Property `e.target` contains a reference to the target element of the event.
- Property `e.currentTarget` contains a reference to the intermediate element that the event is currently traversing. When the event reaches the target, `e.currentTarget` and `e.target` will have the same value.

Object `e` is very important because it gives us a chance to understand where the event is currently at in the subtree. However remember that if some event handler calls `e.stopPropagation()`, then the event will not proceed any further. So, to understand this dynamics, let's make a simulation with this example by considering 2 cases.

##### Non stopping the propagation
When no handler stops the propagation of the event, we have the following scenario:

| # | Element                   | Handler? | Stops? | `e.target`            | `e.currentTarget`         |
|:-:|:--------------------------|:--------:|:------:|:---------------------:|:-------------------------:|
| 1 | `<body>`                  | No       | N/A    | `<div class="house">` | `<body>`                  |
| 2 | `<div class="contianer">` | Yes      | No     | `<div class="house">` | `<div class="contianer">` |
| 3 | `<div class="house">`     | Yes      | No     | `<div class="house">` | `<div class="house">`     |

Note that `body` cannot stop the propagation because there is no handler defined there.

##### Stopping the propagation
When `<div class="contianer">` stops the propagation of the event, we have the following scenario:

| # | Element                   | Handler? | Stops? | `e.target`            | `e.currentTarget`         |
|:-:|:--------------------------|:--------:|:------:|:---------------------:|:-------------------------:|
| 1 | `<body>`                  | No       | N/A    | `<div class="house">` | `<body>`                  |
| 2 | `<div class="contianer">` | Yes      | Yes    | `<div class="house">` | `<div class="contianer">` |

Since `<div class="contianer">` stops the propagation, the event will not reach `<div class="house">`!
